<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Julie is having fun</title>

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.0/dijit/themes/claro/claro.css">
  <link rel="stylesheet" href="https://js.arcgis.com/4.0/esri/css/main.css">
  <script src="https://js.arcgis.com/4.0/"></script>

  <script>
    require([
      "esri/Map",
      "esri/layers/Layer",
      "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/renderers/SimpleRenderer",
      "esri/symbols/SimpleFillSymbol",
      "esri/symbols/SimpleMarkerSymbol",
      "esri/tasks/QueryTask",
      "esri/tasks/support/Query",
      "dojo/_base/array",
      "esri/views/MapView",
      "esri/geometry/geometryEngine",
      "dojo/domReady!"
    ], function(
      Map,
      Layer,
      FeatureLayer,
      GraphicsLayer,
      Graphic,
      SimpleRenderer,
      SimpleFillSymbol,
      SimpleMarkerSymbol,
      QueryTask,
      Query,
      arrayUtils,
      MapView,
      geometryEngine
    ) {

      var polySym = new SimpleFillSymbol({
          color: [255, 255, 255, 0.5],
          outline: {
            color: [0, 0, 0, 0.5],
            width: 2
          }
        });

      var markerSym = new SimpleMarkerSymbol({
          color: [255, 255, 255, 0.5],
          outline: {
            color: [0, 0, 0, 0.5],
            width: 2
          }
        });


      /*****************************************************************
       *  Point QueryTask to URL of feature service  
       *****************************************************************/
      var queryTask = new QueryTask({
        url: "http://services6.arcgis.com/Pu6Fai10JE2L2xUd/arcgis/rest/services/Parks/FeatureServer/0"
      });

      /******************************************************************    
       * Set the query parameters to always return geometry and all fields.
       * Returning geometry allows us to display results on the map/view
       ******************************************************************/
      var params = new Query({
        returnGeometry: true
      });

      // Create the Map
      var map = new Map({
        basemap: "topo"
      });

      // Create the MapView
      var view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-88.152, 41.747],
        zoom: 17
      });

      // Get the screen point from the view's click event
      view.on("click", function(evt){
        // Search for graphics at the clicked location
        view.hitTest(evt.screenPoint).then(function(response){
          if(response.results[0].graphic){
            console.log("Top graphic found! Here it is: ", response.results[0].graphic);
            bufferLayer.removeAll();
            resultsLayer.removeAll();
          }
        });
      });
     
      // Add this action to the popup so it is always available in this view
      var bufferAction = {
        title: "Buffer",
        id: "buffer-this",
        image: "buffer.png"
      };

      /* LAYERS */
      parksLayer = new FeatureLayer({
        url: "http://services6.arcgis.com/Pu6Fai10JE2L2xUd/arcgis/rest/services/Parks/FeatureServer/0",
        outFields: ["*"]
      });

      parcelLayer = new FeatureLayer({
        url: "http://tryitlive.arcgis.com/arcgis/rest/services/TaxParcelQueryIL/MapServer/0",
        outFields: ["*"]
      });       

      bufferLayer = new GraphicsLayer(); 
      resultsLayer = new GraphicsLayer();

      map.addMany([bufferLayer, resultsLayer, parksLayer]);

      Layer.fromPortalItem({
          portalItem: { // autocast as esri/portal/PortalItem
            id: "b6ff65334282454f98bb48e23aa0011d"
          }
        }).then(addLayer)
        .otherwise(rejection);               

      /* METHODS */

      // Adds the layer to the map once it loads
      function addLayer(lyr) {
        lyr.then(function(){lyr.popupTemplate.actions = [bufferAction]});        
        map.add(lyr);
      }

      function rejection(err) {
        console.log("Layer failed to load: ", err);
      }
      
      // Execute each time "Buffer" is clicked
      function bufferThis() {

        var geom = view.popup.selectedFeature.geometry;
        var buffer = geometryEngine.geodesicBuffer(geom, .15, "miles");
        bufferLayer.add(new Graphic({
          geometry: buffer,
          symbol: polySym
        }));

        // animate to the results after they are added to the map  
        view.goTo(buffer);

        doQuery(buffer);
      }
    
      function doQuery(geom) {
        params.geometry = geom;

        queryTask.execute(params)
          .then(getResults)
          .otherwise(promiseRejected);
      }

      // Called each time the promise is resolved    
      function getResults(response) {

        // Loop through each of the results and assign a symbol 
        var results = arrayUtils.map(response.features, function(feature) {
            feature.symbol = new SimpleMarkerSymbol({
              style: "circle",
              size: 20,
              color: [211, 255, 0, 0],
              outline: {
                width: 3,
                color: "#000000",
                style: "solid"}});

            return feature;

          });
        resultsLayer.addMany(results);
      }

      // Called each time the promise is rejected    
      function promiseRejected(err) {
        console.error("Promise rejected: ", err.message);
      }

      // Event handler that fires each time an action is clicked.
      view.popup.on("trigger-action", function(evt) {
        // Execute the bufferThis() function if the measure-this action is clicked
        if (evt.action.id === "buffer-this") {
          bufferThis();
        }
      });
    });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
</body>

</html>
